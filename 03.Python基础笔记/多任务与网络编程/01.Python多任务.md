# 01.Python多任务

过去，我们开发出的所有代码都是单任务的，即函数或者方法总是排队依次运行，如果前一个任务没有完成，那么之后的任务也无法继续。然而，操作系统是支持多任务的，多任务是指在**同一时间内**执行**多个任务**，从而充分利用CPU资源，提高程序的执行效率。

https://python-parallel-programmning-cookbook.readthedocs.io/zh-cn/latest/index.html

## 一、多任务的执行方式

**多任务的执行方式有两种**，分别是**并发**（`concurrency`）和**并行**（`parallel`）。并发是指同一时刻只能有一条指令执行，但是对应的指令在各个程序之间快速转换。比如某个单核的`cpu`下的操作系统在处理任务时，选择轮流**让各个软件交替执行**，软件`a`执行0.01秒，切换到软件`b`执行0.01秒，...，如此反复执行下去，表面上两个软件都在执行，但微观上其实只有一个程序在同时执行。并行是指同一时刻，有多条指令在多个处理器上同时执行，并行必须要依赖于多个处理器，不论是从宏观上还是微观上，多个程序可以在同一时刻一起执行。

在软件开发层，很多情况下无需严格区分并发和并行两个词，一般统一将多线程、多进程和异步`I/O`统称为并发编程，但实际上，多线程和多进程属于并行编程，异步任务属于并发编程。

## 二、线程与进程

### 1.进程

进程是操作系统中执行的一个程序，操作系统以进程为单位分配存储空间，每个进程都有自己的地址空间、数据栈以及其他用于跟踪进程执行的辅助数据，操作系统管理所有进程的执行，为它们合理的分配资源。可以将进程理解为一个公司，公司中不仅有员工，还有很多办公资源（电脑、桌椅等）。

| 处理器型号 | 内核数（P+E） | 线程数 | 缓存   | 睿频频率（P/E） | 基本频率（P/E） |
| ---------- | ------------- | ------ | ------ | --------------- | --------------- |
| `14900KF`  | `24(8+16)`    | `32`   | `36MB` | `5.6/4.4`       | `3.2/2.4`       |

> 处理器型号中`14`指`14`代处理器，`900`指奔腾`900`，即`i9`，后缀字母包含`F`则代表无核显，包含`K`则达标支持超频，包含`S`代表轻松超频。其中核显指`cpu`中是否包含显卡，无核显的`cpu`必须配备显卡，否则无法显示，有核显的可以无需配置显卡显示，但显卡只是简单显卡。超频指是否支持将一个物理内核当作两个逻辑内核来使用。
>
> 英特尔的第 `12` 代` CPU` 改变了内核架构，其中包含`E-Cores` 和 `P-Cores`，其中`P-Core` 通常会处理较重的任务，例如游戏或更重的处理负载，以及通常受益于单核性能的其他工作负载，`P`核即为过去的内核。`E-Cores `比` P-Cores` 更小更弱，同时消耗更小的功率，其主要负责日常后台任务，减轻`P`核心负担。

> 一般而言，`CPU`的内核数（物理内核）既代表了计算机最大进程数（逻辑内核），支持超频的物理内核超频后可等价于两个逻辑内核，如上`14900KF`最大支持`32`进程，`mac`的芯片则会明确标出。

由于不同的进程中分配了独立不同的内存资源，因此其协同使用比较复杂需要使用进程间通信机制（`IPC，Inter-Process Communication`）来实现数据共享，具体的方式包括管道、信号、套接字、共享内存区等，这里只需要简单理解进程协同使用相对比较复杂，也比较消耗性能。

### 2.线程

一个进程内部除了包含固定的内存资源外，还包含多个可以获得`CPU`调度的执行单元，这就是所谓的线程，线程是`cpu`调度的基本单位，假如进程是一个公司的话，可以将线程理解为员工。

> - **线程**是计算机可以被`cpu`调度的最小单元
> - **进程**是操作系统分配资源的的最小单元，进程可以为线程提供运行资源。

一个程序运行背后至少包括一个进程，一个进程至少拥有一个可供调度的线程，这个线程一般可称之为主线程，进程内部一般可以创建多个线程。线程是依附于进程内部的算力资源，没有进程就没有线程。

线程隶属于同一个进程，其内部共享相同的内存空间，因此相对于进程而言，线程间的信息共享和通信更加容易。在单核`CPU`系统中，真正的并发是不可能的，因为在某个时刻能够获得`CPU`的只有唯一的一个线程，多个线程共享了`CPU`的执行时间。

### 3.线程与进程的区别

使用多线程实现并发编程能够极大的提升程序性能和改善用户体验，当然，多线程也带来一些问题，站在其他程序的角度，多线程程序占用过多`CPU`资源导致其他程序无法获得足够的执行时间，站在开发者的角度，开发和调试多线程的程序比较复杂。`Python`既支持多进程又支持多线程，因此使用`Python`实现并发编程主要有3种方式：多进程、多线程、多进程+多线程。

## 三、异步任务

将任务序列化后存储在任务队列中，调度程序以交叉的形式执行任务队列中的任务，任务的执行顺序往往不能保证，其执行顺序取决于队列中的一项任务是否愿意将`CPU`处理时间让位给另一项任务。异步任务通常通过多任务协作处理的方式来实现，由于执行时间和顺序的不确定，因此需要通过回调式编程或者`future`对象来获取任务执行的结果。`Python 3`通过`asyncio`模块和`await`和`async`关键字（在`Python 3.7`中正式被列为关键字）来支持异步处理。

## 四、如何设计一个多任务程序

没有最好的多任务模型，只有更适合业务的多任务模型，`Python`支持的多任务模型主要包括`多线程`、`多进程`和`异步I/O`，通常情况下一个多任务的设计大致包含如下几个方面：

### 1.任务分解

将程序分解为可以在不同处理器执行的多个任务或一系列指令以实现并行性，可以按照范围分解，例如用同一个程序处理相同的数据，也可以按照功能分解，使用一系列具有先后顺序的程序处理数据。

### 2.任务分配

将任务通过程序分配给处理器，应保证处理器保持工作状态避免长时间的空闲，保证各个处理器处理合适自己的任务，同时也必须减少处理器之间的通讯。

#### 3.映射与动态映射

将任务从总体方面设计。如考虑各段程序的性能和处理时间，减小总体的执行时间，频繁通讯的任务由同一个异步处理器处理以增强局部性，其他任务分配给并行任务。任何时候设计一个高效的映射和聚合架构都是有难度的，程序执行期间通信量或任务量改变总是变化的，任务的重要程度也不一。因此可以考虑对不同的任务选择不同的负载均衡算法，一种比较简单的思路是采用任务调度算法，通过维护一个任务池，任务池中包含待执行的具有不同特征的任务，处理器从中依次取出任务交给其他处理器执行。